#!/usr/bin/env bash

set -e

CLAUDE_SKILLS_DIR="${HOME}/.claude/skills"
MARKETPLACE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REGISTRY_FILE="${MARKETPLACE_DIR}/registry.json"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
error() {
  echo -e "${RED}Error: $1${NC}" >&2
  exit 1
}

success() {
  echo -e "${GREEN}$1${NC}"
}

warning() {
  echo -e "${YELLOW}$1${NC}"
}

# Check if jq is installed
command -v jq >/dev/null 2>&1 || error "jq is required. Install it with: brew install jq"

# Command: install <skill-name>
cmd_install() {
  local skill_name=$1
  [[ -z "$skill_name" ]] && error "Usage: gh skills install <skill-name>"

  local target_dir="${CLAUDE_SKILLS_DIR}/${skill_name}"

  # Check if already installed
  if [[ -d "$target_dir" ]]; then
    warning "Skill '${skill_name}' is already installed at ${target_dir}"
    read -p "Overwrite? (y/N): " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 0
    rm -rf "$target_dir"
  fi

  # Check if skill exists in builtin skills
  if [[ -d "${MARKETPLACE_DIR}/skills/${skill_name}" ]]; then
    mkdir -p "$CLAUDE_SKILLS_DIR"
    cp -r "${MARKETPLACE_DIR}/skills/${skill_name}" "$target_dir"
    success "✓ Installed '${skill_name}' to ${target_dir}"
    return
  fi

  # Check external registry
  if jq -e ".external[\"${skill_name}\"]" "$REGISTRY_FILE" >/dev/null 2>&1; then
    local repo_url
    repo_url=$(jq -r ".external[\"${skill_name}\"].repo" "$REGISTRY_FILE")
    local repo_path
    repo_path=$(jq -r ".external[\"${skill_name}\"].path // \"\"" "$REGISTRY_FILE")

    warning "External skill installation not yet implemented"
    error "Cannot install '${skill_name}' from ${repo_url}"
  fi

  error "Skill not found: ${skill_name}\nRun 'gh skills search' to see available skills"
}

# Command: uninstall <skill-name>
cmd_uninstall() {
  local skill_name=$1
  [[ -z "$skill_name" ]] && error "Usage: gh skills uninstall <skill-name>"

  local target_dir="${CLAUDE_SKILLS_DIR}/${skill_name}"

  if [[ ! -d "$target_dir" ]]; then
    error "Skill '${skill_name}' is not installed"
  fi

  read -p "Remove '${skill_name}' from ${target_dir}? (y/N): " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    rm -rf "$target_dir"
    success "✓ Removed '${skill_name}'"
  else
    echo "Cancelled"
  fi
}

# Command: list
cmd_list() {
  if [[ ! -d "$CLAUDE_SKILLS_DIR" ]]; then
    warning "No skills installed yet"
    return
  fi

  echo "Installed skills:"
  echo

  for skill_dir in "${CLAUDE_SKILLS_DIR}"/*; do
    if [[ -d "$skill_dir" ]]; then
      local skill_name
      skill_name=$(basename "$skill_dir")

      # Try to get description from SKILL.md
      local desc=""
      if [[ -f "${skill_dir}/SKILL.md" ]]; then
        desc=$(grep -m 1 "^description:" "${skill_dir}/SKILL.md" | sed 's/description: *//')
      fi

      echo "  ${GREEN}${skill_name}${NC}"
      [[ -n "$desc" ]] && echo "    ${desc}"
      echo
    fi
  done
}

# Command: search [query]
cmd_search() {
  local query=$1

  echo "Available skills in marketplace:"
  echo

  # Search builtin skills
  jq -r '.skills | to_entries[] | "\(.key)|\(.value.description)"' "$REGISTRY_FILE" | while IFS='|' read -r name desc; do
    if [[ -z "$query" ]] || [[ "$name" == *"$query"* ]] || [[ "$desc" == *"$query"* ]]; then
      echo "  ${GREEN}${name}${NC}"
      echo "    ${desc}"
      echo "    Source: builtin"
      echo
    fi
  done

  # Search external skills
  local external_count
  external_count=$(jq '.external | length' "$REGISTRY_FILE")
  if [[ "$external_count" -gt 0 ]]; then
    jq -r '.external | to_entries[] | "\(.key)|\(.value.description)|\(.value.repo)"' "$REGISTRY_FILE" | while IFS='|' read -r name desc repo; do
      if [[ -z "$query" ]] || [[ "$name" == *"$query"* ]] || [[ "$desc" == *"$query"* ]]; then
        echo "  ${GREEN}${name}${NC}"
        echo "    ${desc}"
        echo "    Source: ${repo}"
        echo
      fi
    done
  fi
}

# Command: info <skill-name>
cmd_info() {
  local skill_name=$1
  [[ -z "$skill_name" ]] && error "Usage: gh skills info <skill-name>"

  # Check builtin
  if jq -e ".skills[\"${skill_name}\"]" "$REGISTRY_FILE" >/dev/null 2>&1; then
    echo "Skill: ${GREEN}${skill_name}${NC}"
    echo
    jq -r ".skills[\"${skill_name}\"] | \"Version: \(.version)\nSource: \(.source)\nPath: \(.path)\nDescription: \(.description)\"" "$REGISTRY_FILE"

    # Show if installed
    if [[ -d "${CLAUDE_SKILLS_DIR}/${skill_name}" ]]; then
      echo
      success "Status: Installed at ${CLAUDE_SKILLS_DIR}/${skill_name}"
    else
      echo
      warning "Status: Not installed"
    fi
    return
  fi

  # Check external
  if jq -e ".external[\"${skill_name}\"]" "$REGISTRY_FILE" >/dev/null 2>&1; then
    echo "Skill: ${GREEN}${skill_name}${NC}"
    echo
    jq -r ".external[\"${skill_name}\"] | \"Repository: \(.repo)\nPath: \(.path // \".\")\nDescription: \(.description)\"" "$REGISTRY_FILE"

    if [[ -d "${CLAUDE_SKILLS_DIR}/${skill_name}" ]]; then
      echo
      success "Status: Installed at ${CLAUDE_SKILLS_DIR}/${skill_name}"
    else
      echo
      warning "Status: Not installed"
    fi
    return
  fi

  error "Skill not found: ${skill_name}"
}

# Command: update <skill-name>
cmd_update() {
  local skill_name=$1
  [[ -z "$skill_name" ]] && error "Usage: gh skills update <skill-name>"

  if [[ ! -d "${CLAUDE_SKILLS_DIR}/${skill_name}" ]]; then
    error "Skill '${skill_name}' is not installed"
  fi

  warning "Update functionality not yet implemented"
  echo "For now, uninstall and reinstall the skill:"
  echo "  gh skills uninstall ${skill_name}"
  echo "  gh skills install ${skill_name}"
}

# Main command dispatcher
main() {
  local command=$1
  shift || true

  case "$command" in
    install)
      cmd_install "$@"
      ;;
    uninstall)
      cmd_uninstall "$@"
      ;;
    list)
      cmd_list "$@"
      ;;
    search)
      cmd_search "$@"
      ;;
    info)
      cmd_info "$@"
      ;;
    update)
      cmd_update "$@"
      ;;
    --help|-h|help|"")
      cat <<EOF
gh-skills - Claude Code Skills Marketplace Manager

Usage:
  gh skills install <skill-name>     Install a skill
  gh skills uninstall <skill-name>   Remove a skill
  gh skills list                     List installed skills
  gh skills search [query]           Search available skills
  gh skills info <skill-name>        Show skill details
  gh skills update <skill-name>      Update a skill (not implemented)
  gh skills help                     Show this help

Examples:
  gh skills search                   # List all skills
  gh skills search review            # Search for skills about review
  gh skills install pr-review-comments
  gh skills list
  gh skills info pr-review-comments
  gh skills uninstall pr-review-comments

Claude Skills Directory: ${CLAUDE_SKILLS_DIR}
Marketplace Directory: ${MARKETPLACE_DIR}
EOF
      ;;
    *)
      error "Unknown command: ${command}\nRun 'gh skills help' for usage"
      ;;
  esac
}

main "$@"
